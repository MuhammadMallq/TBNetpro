digraph PyRTC_Flowchart {
    // General Settings
    rankdir=TB;
    fontname="Segoe UI, Arial";
    fontsize=12;
    nodesep=0.4;
    ranksep=0.5;
    splines=ortho; // Cleaner lines

    // Node Style Definitions
    node [fontname="Segoe UI Semibold", fontsize=10, style=filled, penwidth=1.2, color="#2d3436"];

    // --- Sections ---

    // Start/End
    start [label="Mulai", shape=oval, fillcolor="#ffeaa7"];
    end   [label="Selesai", shape=oval, fillcolor="#ffeaa7"];

    // Client Initialization
    subgraph cluster_init {
        label="Fase Inisialisasi";
        color="#b2bec3";
        style=dashed;
        input [label="Input Username\n& Server IP:Port", shape=parallelogram, fillcolor="#dff9fb"];
        connect [label="Koneksi TCP & Handshake\n(Exchange Metadata)", shape=rect, fillcolor="#dff9fb"];
        is_ok [label="Koneksi\nBerhasil?", shape=diamond, fillcolor="#d1fae5", color="#10b981"];
        show_ui [label="Buka UI Dashboard\n(Load Theme)", shape=rect, fillcolor="#dff9fb"];
    }

    // Event Loop
    subgraph cluster_loop {
        label="Event Loop (Multithreaded)";
        color="#b2bec3";
        style=dashed;

        has_act [label="Aktivitas System?", shape=diamond, fillcolor="#d1fae5", color="#10b981"];

        // User Inputs
        subgraph cluster_user {
            label="Input Pengguna";
            color="#ecf0f1";
            typing   [label="Cek Typing Indicator\n(Send [TYPING])", shape=rect, fillcolor="#e0e7ff"];
            send_msg [label="Kirim Pesan Chat\n(Format Protocol)", shape=rect, fillcolor="#e0e7ff"];
            react    [label="Tambah Reaction\n(Right Click Menu)", shape=rect, fillcolor="#e0e7ff"];
            theme    [label="Switch Theme\n(Dark/Light Mode)", shape=rect, fillcolor="#e0e7ff"];
        }

        // Server Events
        subgraph cluster_server {
            label="Data dari Server";
            color="#fef3c7";
            proc_msg [label="Update Chat Display\n& Read Receipt", shape=rect, fillcolor="#fef3c7"];
            proc_status [label="Update Typing/Reactions\n& Message Status", shape=rect, fillcolor="#fef3c7"];
        }
    }

    // Termination
    exit_q [label="Logout / Tutup\nAplikasi?", shape=diamond, fillcolor="#d1fae5", color="#10b981"];
    cleanup [label="Cleanup Threads &\nClose Socket", shape=rect, fillcolor="#fab1a0"];

    // --- Logic Flow (Edges) ---
    edge [fontname="Segoe UI", fontsize=9, color="#636e72", arrowsize=0.8];

    start -> input;
    input -> connect;
    connect -> is_ok;

    is_ok -> end [label="Gagal"];
    is_ok -> show_ui [label="Sukses"];
    
    show_ui -> has_act;

    // Dispatching Events
    has_act -> typing [label="Keyboard Input"];
    has_act -> send_msg [label="Button Send"];
    has_act -> react [label="Click Message"];
    has_act -> theme [label="Click Icon"];
    has_act -> proc_msg [label="Pesan Baru"];
    has_act -> proc_status [label="Status Update"];

    // Syncing back to loop
    typing -> exit_q;
    send_msg -> exit_q;
    react -> exit_q;
    theme -> exit_q;
    proc_msg -> exit_q;
    proc_status -> exit_q;

    exit_q -> has_act [label="Tidak (Loop)"];
    exit_q -> cleanup [label="Ya"];
    
    cleanup -> end;
}
